<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UINRENT – Admin Panel (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script> 
    <style>
        :root {
            --primary: #FF7F00;
            --primary-light: #FF9933;
            --card-bg: #1F2937; /* Gray-800 equivalent */
            --dark-bg: #111827; /* Gray-900 equivalent */
        }
        body {font-family:'Inter',sans-serif;background:var(--dark-bg);color:#f3f4f6;}
        .btn-primary{background:var(--primary);color:#111827;font-weight:600;transition:transform .1s;}
        .btn-primary:hover{background:var(--primary-light);transform:translateY(-1px);}
        .card{background:var(--card-bg);border:1px solid #374151;box-shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);}
        .input{border:1px solid #4b5563;background:#1F2937;color:#fff;}
        .input:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 2px rgba(255, 127, 0, 0.5);}
        .badge-new{background:#047857;color:#fff;} /* Green */
        .badge-popular{background:#DC2626;color:#fff;} /* Red */
        .modal-content{max-height:90vh;overflow-y:auto;}
        .hidden{display:none !important;}
        .animate-fade{animation:fadeIn .4s ease forwards;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:none}}

        /* === NEW CSS FOR UPLOADS === */
        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--primary);
            margin: 4px;
            position: relative;
        }
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #4b5563;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--primary);
            transition: width .3s;
        }
        #save-button .fa-spinner {
            display: none; /* Hide spinner by default */
        }
        #save-button:disabled .fa-spinner {
            display: inline-block; /* Show when button is disabled */
        }
        #save-button:disabled .save-text {
            display: none; /* Hide 'Save' text when disabled */
        }
        
        /* === NEW: Password Eye Icon === */
        .password-wrapper {
            position: relative;
        }
        #toggle-password {
            position: absolute;
            top: 50%;
            right: 0.75rem; /* 12px */
            transform: translateY(-50%);
            cursor: pointer;
            color: #9CA3AF; /* gray-400 */
        }
        #toggle-password:hover {
            color: #fff;
        }
    </style>
</head>
<body class="min-h-screen">

<div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
    <div class="card rounded-2xl p-8 w-full max-w-md shadow-2xl">
        <h1 class="text-5xl font-extrabold text-center text-orange-500 mb-2">UINRENT</h1>
        <p class="text-center text-gray-400 mb-8 font-light">Admin Access Required</p>
        <form id="login-form" class="space-y-6">
            <div>
                <label class="block text-sm font-medium mb-1 text-gray-300">Email</label>
                <input type="email" id="admin-email" class="input w-full p-3 rounded-xl focus:ring-2" placeholder="admin@uinrent.com" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1 text-gray-300">Password</label>
                <div class="password-wrapper">
                    <input type="password" id="admin-pass" class="input w-full p-3 rounded-xl focus:ring-2 pr-10" placeholder="••••••••" required>
                    <i class="fas fa-eye" id="toggle-password"></i>
                </div>
            </div>
            <button type="submit" class="w-full btn-primary font-bold py-3 rounded-xl shadow-lg">Login Securely</button>
            <p id="login-error" class="text-red-400 text-center text-sm hidden mt-3 font-semibold">Invalid credentials. Please check your login details.</p>
        </form>
    </div>
</div>

<div id="dashboard" class="hidden min-h-screen p-4 md:p-10">
    <header class="flex flex-col md:flex-row justify-between items-center pb-6 border-b border-gray-700 mb-8">
        <h1 class="text-4xl font-extrabold text-orange-500 mb-2 md:mb-0">Fleet Dashboard</h1>
        <div class="flex space-x-3 items-center">
            <button onclick="openAddModal()" class="btn-primary flex items-center px-4 py-2 rounded-xl shadow-md">
                <i class="fas fa-plus mr-2"></i> Add New Vehicle
            </button>
            <button onclick="logout()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-xl shadow-md">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
        <div class="card p-6 rounded-2xl shadow-xl">
            <h3 class="text-lg font-semibold mb-3 text-gray-400">Total Cars Managed</h3>
            <p id="total-cars" class="text-4xl font-bold text-orange-400">0</p>
        </div>
        <div class="card p-6 rounded-2xl shadow-xl">
            <h3 class="text-lg font-semibold mb-3 text-gray-400">Rentals (This Month)</h3>
            <p id="total-rentals" class="text-4xl font-bold text-green-400">0</p>
        </div>
        <div class="card p-6 rounded-2xl shadow-xl">
            <h3 class="text-lg font-semibold mb-3 text-gray-400">Total Revenue (This Month)</h3>
            <p id="total-revenue" class="text-4xl font-bold text-blue-400">€0.00</p>
        </div>
    </div>

    <div class="card p-6 rounded-2xl overflow-x-auto shadow-2xl mb-10">
        <h2 class="text-2xl font-bold mb-5 text-gray-200">Rentals This Month</h2>
        <table class="w-full text-left table-auto min-w-max">
            <thead class="border-b-2 border-green-500 text-gray-400 text-sm uppercase">
                <tr>
                    <th class="py-3 px-3">Date Booked</th>
                    <th class="py-3 px-3">Car Model</th>
                    <th class="py-3 px-3">Customer</th>
                    <th class="py-3 px-3">Rental Dates</th>
                    <th class="py-3 px-3 text-center">Sundays</th>
                    <th class="py-3 px-3">Total</th>
                </tr>
            </thead>
            <tbody id="rentals-table-body" class="divide-y divide-gray-700">
                </tbody>
        </table>
        <p id="empty-rentals-message" class="text-center text-gray-500 p-8 hidden">
            No rentals have been booked this month.
        </p>
    </div>

    <div class="card p-6 rounded-2xl overflow-x-auto shadow-2xl">
        <h2 class="text-2xl font-bold mb-5 text-gray-200">Vehicle Inventory</h2>
        <table class="w-full text-left table-auto min-w-max">
            <thead class="border-b-2 border-orange-500 text-gray-400 text-sm uppercase">
                <tr>
                    <th class="py-3 px-3">Model</th>
                    <th class="py-3 px-3">Price</th>
                    <th class="py-3 px-3">Image</th>
                    <th class="py-3 px-3">Specs</th>
                    <th class="py-3 px-3">Badge</th>
                    <th class="py-3 px-3">Actions</th>
                </tr>
            </thead>
            <tbody id="cars-table-body" class="divide-y divide-gray-700">
                </tbody>
        </table>
        <p id="empty-fleet-message" class="text-center text-gray-500 p-8 hidden">
            The fleet is empty. Use the "Add New Vehicle" button to populate the inventory.
        </p>
    </div>
</div>

<div id="car-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden p-4">
    <div class="card w-full max-w-4xl rounded-2xl modal-content shadow-2xl modal animate-fade">
        <div class="p-6">
            <div class="flex justify-between items-center pb-4 border-b border-gray-700 mb-6">
                <h2 id="modal-title" class="text-3xl font-bold text-orange-400">Add New Car</h2>
                <button onclick="closeModal('car-modal')" class="text-gray-400 hover:text-white text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="car-form" class="space-y-6">
                <input type="hidden" id="edit-id">

                <fieldset class="border border-gray-700 p-4 rounded-xl">
                    <legend class="text-lg font-semibold text-orange-400 px-2">Vehicle Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Model Name</label>
                            <input type="text" id="model" class="input w-full p-3 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Price per Day (49.99€)</label>
                            <input type="number" id="price" min="1" class="input w-full p-3 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Badge</label>
                            <select id="badge" class="input w-full p-3 rounded-lg">
                                <option value="">None</option>
                                <option value="new">New Arrival</option>
                                <option value="popular">Popular Choice</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Seats</label>
                            <input type="number" id="seats" min="2" max="9" class="input w-full p-3 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Luggage (bags)</label>
                            <input type="number" id="luggage" min="1" max="10" class="input w-full p-3 rounded-lg" required>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1">Range / Engine (e.g. Fuel-efficient)</label>
                            <input type="text" id="range" class="input w-full p-3 rounded-lg" required>
                        </div>
                    </div>
                </fieldset>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <fieldset class="border border-gray-700 p-4 rounded-xl">
                        <legend class="text-lg font-semibold text-orange-400 px-2">Images</legend>
                        
                        <label class="block text-sm font-medium mb-1">Upload Images</label>
                        <input type="file" id="image-upload" class="input w-full p-2" multiple accept="image/png, image/jpeg, image/webp">
                        <p class="text-xs text-gray-400 mt-1">**First image is the main one.** (Max 5MB each)</p>
                        
                        <div id="image-previews-container" class="mt-4 flex flex-wrap gap-2">
                            </div>
                    </fieldset>

                    <fieldset class="border border-gray-700 p-4 rounded-xl">
                        <legend class="text-lg font-semibold text-orange-400 px-2">Descriptions</legend>
                        <label class="block text-sm font-medium mb-1">Description (EN)</label>
                        <textarea id="desc_en" rows="3" class="input w-full p-3 rounded-lg mb-4" required></textarea>
                        <label class="block text-sm font-medium mb-1">Description (RO)</label>
                        <textarea id="desc_ro" rows="3" class="input w-full p-3 rounded-lg" required></textarea>
                    </fieldset>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('car-modal')" class="px-5 py-2 bg-gray-600 hover:bg-gray-500 rounded-xl text-white">Cancel</button>
                    <button type="submit" id="save-button" class="px-5 py-2 btn-primary rounded-xl shadow-lg w-36 text-center">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span class="save-text">Save Vehicle</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="custom-alert-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[70] hidden p-4">
    <div class="card w-full max-w-sm p-6 rounded-2xl modal animate-fade shadow-2xl">
        <h3 id="custom-alert-title" class="text-2xl font-bold mb-3 text-orange-400"></h3>
        <p id="custom-alert-message" class="text-gray-300 mb-6"></p>
        <div id="custom-alert-actions" class="flex justify-end space-x-3">
            </div>
    </div>
</div>


<script>
    // ===============================================
    // === 1. YOUR FIREBASE CONFIG                 ===
    // ===============================================
    const firebaseConfig = {
      apiKey: "AIzaSyAQi_9PATsfdGL_StdPbtyYJPZsla5SwDY",
      authDomain: "uin-rent-website.firebaseapp.com",
      projectId: "uin-rent-website",
      storageBucket: "uin-rent-website.firebasestorage.app",
      messagingSenderId: "200564838706",
      appId: "1:200564838706:web:e6b77a3e1c99d8d7ea472b"
    };
    
    // ===============================================
    // === 2. INITIALIZE FIREBASE & GLOBALS        ===
    // ===============================================
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const carsCollection = db.collection("cars");
    const rentalsCollection = db.collection("rentals");

    let editingId = null;

    // ===============================================
    // === 3. AUTHENTICATION (SECURE VERSION)        ===
    // ===============================================
    
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('admin-email').value;
        const pass = document.getElementById('admin-pass').value;
        const errorP = document.getElementById('login-error');

        try {
            await firebase.auth().signInWithEmailAndPassword(email, pass);
            errorP.classList.add('hidden');
        } catch (error) {
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                errorP.textContent = 'Invalid email or password.';
            } else {
                errorP.textContent = 'An unknown error occurred. Please try again.';
            }
            errorP.classList.remove('hidden');
        }
    });

    function logout() {
        firebase.auth().signOut();
    }
    
    // === NEW: Password Toggle ===
    const togglePassword = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('admin-pass');
    togglePassword.addEventListener('click', function (e) {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
    });

    /* ==================== UTILITIES & CUSTOM MODALS ==================== */
    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

    function showCustomMessage(title, message) {
        const modal = document.getElementById('custom-alert-modal');
        document.getElementById('custom-alert-title').textContent = title;
        document.getElementById('custom-alert-message').textContent = message;
        const actionsDiv = document.getElementById('custom-alert-actions');
        actionsDiv.innerHTML = `<button onclick="closeModal('custom-alert-modal')" class="px-5 py-2 bg-gray-600 hover:bg-gray-500 rounded-xl text-white">OK</button>`;
        modal.classList.remove('hidden');
    }

    function showCustomConfirm(title, message, confirmCallback) {
        const modal = document.getElementById('custom-alert-modal');
        document.getElementById('custom-alert-title').textContent = title;
        document.getElementById('custom-alert-message').textContent = message;
        const actionsDiv = document.getElementById('custom-alert-actions');
        
        actionsDiv.innerHTML = `
            <button onclick="closeModal('custom-alert-modal')" class="px-5 py-2 bg-gray-600 hover:bg-gray-500 rounded-xl text-white">Cancel</button>
            <button id="confirm-action-btn" class="px-5 py-2 btn-primary rounded-xl">Confirm</button>
        `;

        const confirmBtn = document.getElementById('confirm-action-btn');
        confirmBtn.onclick = () => {
             closeModal('custom-alert-modal');
             confirmCallback();
        };
        modal.classList.remove('hidden');
    }

    /* ==================== DATA LOADING & RENDERING ==================== */
    function loadData() {
        loadRentals();
        loadCars();
    }

    // === RENTALS DASHBOARD (REAL-TIME) ===
    function loadRentals() {
        const tbody = document.getElementById('rentals-table-body');
        tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-xl"></i> Loading...</td></tr>';

        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
        
        rentalsCollection
            .where('rentalDate', '>=', startOfMonth)
            .orderBy('rentalDate', 'desc')
            .onSnapshot(snapshot => {
                let totalRevenue = 0;
                let rentalCount = 0;

                if (snapshot.empty) {
                    document.getElementById('empty-rentals-message').classList.remove('hidden');
                    tbody.innerHTML = '';
                } else {
                    document.getElementById('empty-rentals-message').classList.add('hidden');
                    tbody.innerHTML = ''; 
                    snapshot.forEach(doc => {
                        const rental = doc.data();
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-800 transition-colors';
                        tr.innerHTML = `
                            <td class="py-3 px-3 text-sm text-gray-400">${new Date(rental.rentalDate).toLocaleDateString()}</td>
                            <td class="py-3 px-3 font-semibold text-white">${rental.carModel}</td>
                            <td class="py-3 px-3 text-sm text-gray-300">
                                ${rental.customerName}<br>
                                <span class="text-xs text-gray-500">${rental.customerPhone || rental.customerEmail}</span>
                            </td>
                            <td class="py-3 px-3 text-sm text-gray-400">${rental.pickupDate} → ${rental.returnDate}</td>
                            <td class="py-3 px-3 text-center text-lg font-bold text-yellow-400">${rental.sundaysCount || 0}</td>
                            <td class="py-3 px-3 font-semibold text-green-400">€${parseFloat(rental.totalCost).toFixed(2)}</td>
                        `;
                        tbody.appendChild(tr);
                        
                        totalRevenue += parseFloat(rental.totalCost);
                        rentalCount++;
                    });
                }
                
                document.getElementById('total-rentals').textContent = rentalCount;
                document.getElementById('total-revenue').textContent = `€${totalRevenue.toFixed(2)}`;

            }, error => {
                console.error("Error listening to rentals: ", error);
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-400">Error loading rentals.</td></tr>';
                if (error.code === 'permission-denied') {
                     showCustomMessage("Error", "Could not load rentals. Make sure your Firestore rules are set up correctly.");
                }
            });
    }

    // === CARS DASHBOARD (REAL-TIME) ===
    function loadCars() {
        const tbody = document.getElementById('cars-table-body');
        tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-xl"></i> Loading...</td></tr>';
        
        carsCollection.orderBy('model').onSnapshot(snapshot => {
            
            if (snapshot.empty) {
                document.getElementById('empty-fleet-message').classList.remove('hidden');
                tbody.innerHTML = '';
                document.getElementById('total-cars').textContent = 0;
            } else {
                document.getElementById('empty-fleet-message').classList.add('hidden');
                tbody.innerHTML = ''; 
                let carCount = 0;
                snapshot.forEach(doc => {
                    const car = doc.data();
                    car.id = doc.id; 
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-800 transition-colors';
                    
                    const badgeHtml = car.badge ? `<span class="badge-${car.badge} px-2 py-1 rounded-full text-xs font-semibold">${car.badge}</span>` : '<span class="text-gray-500 text-xs">None</span>';
                    
                    const imageUrl = car.images && car.images.length > 0
                        ? car.images[0]
                        : 'https://placehold.co/80x40/1F2937/6B7280?text=No+Img';

                    tr.innerHTML = `
                        <td class="py-3 px-3 font-semibold text-white">${car.model}</td>
                        <td class="py-3 px-3 font-semibold text-green-400">€${car.price_per_day || 'N/A'}</td>
                        <td class="py-3 px-3">
                            <img src="${imageUrl}" alt="${car.model}" class="w-20 h-10 object-cover rounded-md border border-gray-600">
                        </td>
                        <td class="py-3 px-3 text-sm text-gray-300">
                            <i class="fas fa-users mr-1 text-orange-400"></i> ${car.seats} seats
                            <br>
                            <i class="fas fa-suitcase-rolling mr-1 text-orange-400"></i> ${car.luggage} bags
                        </td>
                        <td class="py-3 px-3">${badgeHtml}</td>
                        <td class="py-3 px-3 flex space-x-2">
                            <button onclick="openEditModal('${car.id}')" class="text-blue-400 hover:text-blue-300 transition-colors">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="confirmDeleteCar('${car.id}')" class="text-red-400 hover:text-red-300 transition-colors">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    carCount++;
                });
                document.getElementById('total-cars').textContent = carCount;
            }
        }, error => {
            console.error("Error listening to cars: ", error);
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-400">Error loading cars.</td></tr>';
            if (error.code === 'permission-denied') {
                 showCustomMessage("Error", "Could not load cars. Make sure your Firestore rules are set up correctly.");
            }
        });
    }

    /* ==================== CAR MODAL CONTROL (ADD/EDIT) ==================== */

    function displayImagePreviews(images = [], container) {
        container.innerHTML = ''; // Clear old previews
        images.forEach(imageUrl => {
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-image';
            wrapper.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-cover rounded-md" data-url="${imageUrl}">`;
            container.appendChild(wrapper);
        });
    }

    window.openAddModal = function() {
        editingId = null;
        document.getElementById('modal-title').textContent = 'Add New Vehicle';
        document.getElementById('car-form').reset();
        document.getElementById('edit-id').value = '';
        document.getElementById('image-previews-container').innerHTML = '';
        document.getElementById('car-modal').classList.remove('hidden');
    }

    window.openEditModal = async function(id) {
        try {
            const docRef = carsCollection.doc(id);
            const doc = await docRef.get();
            if (!doc.exists) {
                showCustomMessage("Error", "Car not found.");
                return;
            }
            const car = doc.data();
            editingId = id;
            
            document.getElementById('modal-title').textContent = `Edit Vehicle: ${car.model}`;
            document.getElementById('edit-id').value = id;
            document.getElementById('model').value = car.model;
            document.getElementById('price').value = car.price_per_day || '';
            document.getElementById('seats').value = car.seats;
            document.getElementById('luggage').value = car.luggage;
            document.getElementById('range').value = car.range;
            document.getElementById('badge').value = car.badge || '';
            document.getElementById('desc_en').value = car.description_en;
            document.getElementById('desc_ro').value = car.description_ro;

            const previewContainer = document.getElementById('image-previews-container');
            displayImagePreviews(car.images || [], previewContainer);

            document.getElementById('car-modal').classList.remove('hidden');
        } catch (error) {
            console.error("Error fetching car for edit: ", error);
            showCustomMessage("Error", "Could not fetch car details.");
        }
    }

    /* ==================== SAVE CAR (ADD/EDIT) ==================== */
    
    function uploadFile(file, container, modelName) {
        return new Promise((resolve, reject) => {
            const fileName = `${Date.now()}-${file.name}`;
            const filePath = `cars/${modelName.replace(/ /g, '_')}/${fileName}`;
            const fileRef = storage.ref(filePath);
            const uploadTask = fileRef.put(file);

            const progressWrapper = document.createElement('div');
            progressWrapper.className = 'w-full';
            progressWrapper.innerHTML = `
                <p class="text-xs text-gray-300 truncate">${file.name}</p>
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
            `;
            container.appendChild(progressWrapper);
            const progressBar = progressWrapper.querySelector('.progress-bar');

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                }, 
                (error) => {
                    console.error("Upload failed: ", error);
                    progressWrapper.innerHTML = `<p class="text-xs text-red-400">Upload failed: ${file.name}</p>`;
                    reject(error);
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        progressWrapper.remove();
                        resolve(downloadURL);
                    }).catch(reject);
                }
            );
        });
    }

    document.getElementById('car-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const saveButton = document.getElementById('save-button');
        saveButton.disabled = true;

        const modelName = document.getElementById('model').value.trim();
        const previewContainer = document.getElementById('image-previews-container');

        const filesToUpload = document.getElementById('image-upload').files;
        let uploadedImageUrls = [];

        try {
            if (filesToUpload.length > 0) {
                previewContainer.innerHTML = '';
                const uploadPromises = [];
                
                for (const file of filesToUpload) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                         showCustomMessage('Error', `File ${file.name} is too large (> 5MB).`);
                         continue;
                    }
                    uploadPromises.push(uploadFile(file, previewContainer, modelName));
                }
                
                uploadedImageUrls = await Promise.all(uploadPromises);

            } else if (editingId) {
                const existingImages = previewContainer.querySelectorAll('img');
                existingImages.forEach(img => {
                    uploadedImageUrls.push(img.getAttribute('data-url'));
                });
            }

            if (uploadedImageUrls.length < 1) {
                showCustomMessage('Image Requirement Failed', 'You must provide at least 1 image.');
                saveButton.disabled = false;
                return;
            }

            const carData = {
                model: modelName,
                price_per_day: +document.getElementById('price').value,
                seats: +document.getElementById('seats').value,
                luggage: +document.getElementById('luggage').value,
                range: document.getElementById('range').value.trim(),
                badge: document.getElementById('badge').value || '',
                images: uploadedImageUrls,
                description_en: document.getElementById('desc_en').value.trim(),
                description_ro: document.getElementById('desc_ro').value.trim(),
            };

            if (editingId) {
                await carsCollection.doc(editingId).set(carData, { merge: true });
                showCustomMessage('Success', `Vehicle ${carData.model} updated.`);
            } else {
                await carsCollection.add(carData);
                showCustomMessage('Success', `New vehicle ${carData.model} added.`);
            }
            
            closeModal('car-modal');
        } catch (error) {
            console.error("Error saving car: ", error);
            showCustomMessage("Error", "Could not save car. Check console.");
        } finally {
            saveButton.disabled = false;
        }
    });

    /* ==================== DELETE CAR ==================== */
    
    window.confirmDeleteCar = async function(id) {
        try {
            const docRef = carsCollection.doc(id);
            const doc = await docRef.get();
            if (!doc.exists) {
                showCustomMessage("Error", "Car not found.");
                return;
            }
            const car = doc.data();
            
            showCustomConfirm(
                'Confirm Vehicle Deletion',
                `Are you sure you want to delete ${car.model}? This action is permanent and will also delete its images.`,
                () => deleteCar(docRef, car)
            );
        } catch (error) {
            showCustomMessage("Error", "Could not fetch car details to delete.");
        }
    }

    async function deleteCar(docRef, carData) {
        try {
            if (carData.images && carData.images.length > 0) {
                const deletePromises = carData.images.map(imageUrl => {
                    if (imageUrl.includes('placehold.co')) {
                        return Promise.resolve();
                    }
                    try {
                        const imageRef = storage.refFromURL(imageUrl);
                        return imageRef.delete();
                    } catch (e) {
                        console.warn("Could not delete image, possibly invalid URL:", imageUrl);
                        return Promise.resolve();
                    }
                });
                
                await Promise.allSettled(deletePromises);
            }
            
            await docRef.delete();
            
            showCustomMessage('Deleted', `Vehicle ${carData.model} was successfully removed.`);
        } catch (error) {
            console.error("Error deleting car or its images: ", error);
            showCustomMessage("Error", "Could not delete car. Check console.");
        }
    }
    
    /* ==================== AUTO LOGIN CHECK ==================== */
    window.addEventListener('load', () => {
        // === UPDATED: Set persistence to NONE ===
        // This forces a logout when the tab is closed.
        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
            .then(() => {
                // Now, set up the listener.
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        loadData(); 
                    } else {
                        document.getElementById('login-screen').classList.remove('hidden');
                        document.getElementById('dashboard').classList.add('hidden');
                    }
                });
            })
            .catch((error) => {
                console.error("Error setting auth persistence: ", error);
            });
    });

    // Make functions globally accessible
    window.openAddModal = openAddModal;
    window.openEditModal = openEditModal;
    window.confirmDeleteCar = confirmDeleteCar;
    window.logout = logout;
    window.closeModal = closeModal;

</script>

</body>
</html>
